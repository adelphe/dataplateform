version: "3.8"

x-airflow-common: &airflow-common
  build:
    context: .
    dockerfile: infrastructure/airflow/Dockerfile
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-airflow}:${POSTGRES_PASSWORD:-airflow}@postgres:5432/${AIRFLOW_DB:-airflow}
    AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-}
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_SECRET_KEY:-change-me-in-production}
    AIRFLOW__LOGGING__LOGGING_LEVEL: ${AIRFLOW__LOGGING__LOGGING_LEVEL:-INFO}
    AIRFLOW__LOGGING__COLORED_CONSOLE_LOG: "False"
    AIRFLOW__METRICS__STATSD_ON: "False"
    AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL: ${AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL:-60}
    AIRFLOW__CORE__PARALLELISM: ${AIRFLOW__CORE__PARALLELISM:-32}
    AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG: ${AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG:-3}
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: ${AIRFLOW__WEBSERVER__EXPOSE_CONFIG:-True}
    AIRFLOW__WEBSERVER__RBAC: "True"
    AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
    AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_ENDPOINT_URL: http://minio:9000
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    POSTGRES_USER: ${POSTGRES_USER:-airflow}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
    POSTGRES_DB: ${POSTGRES_DB:-airflow}
  volumes:
    - ./pipelines/dags:/opt/airflow/dags
    - ./pipelines/plugins:/opt/airflow/plugins
    - ./pipelines/logs:/opt/airflow/logs
    - ./pipelines/operators:/opt/airflow/operators
    - ./pipelines/utils:/opt/airflow/utils
    - ./pipelines/config:/opt/airflow/config
    - ./pipelines/ingestion:/opt/airflow/ingestion
    - ./scripts:/opt/airflow/scripts
  depends_on:
    postgres:
      condition: service_healthy

services:
  # -- PostgreSQL --
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-airflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
      POSTGRES_DB: ${POSTGRES_DB:-airflow}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-airflow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -- MinIO (S3-compatible object storage) --
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -- MinIO Bucket Initialization --
  minio-init:
    image: minio/mc:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      MINIO_HOST: minio
      MINIO_PORT: "9000"
    volumes:
      - ./infrastructure/minio/init-buckets.sh:/init-buckets.sh
    entrypoint: /bin/sh
    command: -c "sleep 5 && /init-buckets.sh"
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"

  # -- Airflow --
  airflow-init:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username ${AIRFLOW_ADMIN_USER:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
        bash /opt/airflow/scripts/init-connections.sh
    volumes:
      - ./pipelines/dags:/opt/airflow/dags
      - ./pipelines/plugins:/opt/airflow/plugins
      - ./pipelines/logs:/opt/airflow/logs
      - ./pipelines/operators:/opt/airflow/operators
      - ./pipelines/utils:/opt/airflow/utils
      - ./pipelines/config:/opt/airflow/config
      - ./pipelines/ingestion:/opt/airflow/ingestion
      - ./infrastructure/airflow/init-connections.sh:/opt/airflow/scripts/init-connections.sh
      - ./scripts:/opt/airflow/scripts/data
    depends_on:
      postgres:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    restart: "no"

  airflow-webserver:
    <<: *airflow-common
    command: webserver
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8080}:8080"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  airflow-scheduler:
    <<: *airflow-common
    command: scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  # -- Superset --
  superset:
    image: apache/superset:3.1.3
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-change-me-in-production}
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USER:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@example.com}
      SUPERSET_ADMIN_FIRSTNAME: Admin
      SUPERSET_ADMIN_LASTNAME: User
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    entrypoint: /bin/bash
    command:
      - -c
      - |
        pip install psycopg2-binary --quiet
        superset db upgrade
        superset fab create-admin \
          --username "$${SUPERSET_ADMIN_USERNAME}" \
          --password "$${SUPERSET_ADMIN_PASSWORD}" \
          --firstname "$${SUPERSET_ADMIN_FIRSTNAME}" \
          --lastname "$${SUPERSET_ADMIN_LASTNAME}" \
          --email "$${SUPERSET_ADMIN_EMAIL}" || true
        superset init
        superset run -h 0.0.0.0 -p 8088
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres-data:
  minio-data:
