version: "3.8"

x-airflow-common: &airflow-common
  build:
    context: .
    dockerfile: infrastructure/airflow/Dockerfile
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-airflow}:${POSTGRES_PASSWORD:-airflow}@postgres:5432/${AIRFLOW_DB:-airflow}
    AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-}
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_SECRET_KEY:-change-me-in-production}
    AIRFLOW__LOGGING__LOGGING_LEVEL: ${AIRFLOW__LOGGING__LOGGING_LEVEL:-INFO}
    AIRFLOW__LOGGING__COLORED_CONSOLE_LOG: "False"
    AIRFLOW__METRICS__STATSD_ON: "False"
    AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL: ${AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL:-60}
    AIRFLOW__CORE__PARALLELISM: ${AIRFLOW__CORE__PARALLELISM:-32}
    AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG: ${AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG:-3}
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: ${AIRFLOW__WEBSERVER__EXPOSE_CONFIG:-True}
    AIRFLOW__WEBSERVER__RBAC: "True"
    AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio}
    AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
    AWS_ENDPOINT_URL: http://minio:9000
    MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
    MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    POSTGRES_USER: ${POSTGRES_USER:-airflow}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
    POSTGRES_DB: ${POSTGRES_DB:-airflow}
    # Great Expectations configuration
    POSTGRES_CONNECTION_STRING: ${POSTGRES_CONNECTION_STRING:-postgresql+psycopg2://airflow:airflow@postgres:5432/airflow}
    BRONZE_DATA_PATH: ${BRONZE_DATA_PATH:-/opt/airflow/data-quality/sample_data}
    MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
    MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minio}
    MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minio123}
    DATA_DOCS_BUCKET: ${DATA_DOCS_BUCKET:-data-docs}
    # OpenMetadata authentication for metadata_sync DAG
    OPENMETADATA_AUTH_PROVIDER: ${OPENMETADATA_AUTH_PROVIDER:-basic}
    OPENMETADATA_JWT_TOKEN: ${OPENMETADATA_JWT_TOKEN:-}
  volumes:
    - ./pipelines/dags:/opt/airflow/dags
    - ./pipelines/plugins:/opt/airflow/plugins
    - ./pipelines/logs:/opt/airflow/logs
    - ./pipelines/operators:/opt/airflow/operators
    - ./pipelines/utils:/opt/airflow/utils
    - ./pipelines/config:/opt/airflow/config
    - ./pipelines/ingestion:/opt/airflow/ingestion
    - ./pipelines/loaders:/opt/airflow/loaders
    - ./transformations:/opt/airflow/transformations
    - ./scripts:/opt/airflow/scripts
    - ./data-quality:/opt/airflow/data-quality
  depends_on:
    postgres:
      condition: service_healthy

services:
  # -- PostgreSQL --
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-airflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
      POSTGRES_DB: ${POSTGRES_DB:-airflow}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init_superset_db.sql:/docker-entrypoint-initdb.d/00_init_superset_db.sql
      - ./infrastructure/postgres/init_ingestion_tables.sql:/docker-entrypoint-initdb.d/01_init_ingestion_tables.sql
      - ./infrastructure/postgres/init_dbt_schemas.sql:/docker-entrypoint-initdb.d/02_init_dbt_schemas.sql
      - ./data-quality/init_validation_tables.sql:/docker-entrypoint-initdb.d/03_init_validation_tables.sql
      - ./infrastructure/postgres/init_monitoring_tables.sql:/docker-entrypoint-initdb.d/04_init_monitoring_tables.sql
      - ./infrastructure/postgres/init_openmetadata_db.sql:/docker-entrypoint-initdb.d/05_init_openmetadata_db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-airflow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -- MinIO (S3-compatible object storage) --
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -- MinIO Bucket Initialization --
  minio-init:
    image: minio/mc:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      MINIO_HOST: minio
      MINIO_PORT: "9000"
    volumes:
      - ./infrastructure/minio/init-buckets.sh:/init-buckets.sh
    entrypoint: /bin/sh
    command: -c "sleep 5 && /init-buckets.sh"
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"

  # -- Airflow --
  airflow-init:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username ${AIRFLOW_ADMIN_USER:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
        bash /opt/airflow/scripts/init-connections.sh
    volumes:
      - ./pipelines/dags:/opt/airflow/dags
      - ./pipelines/plugins:/opt/airflow/plugins
      - ./pipelines/logs:/opt/airflow/logs
      - ./pipelines/operators:/opt/airflow/operators
      - ./pipelines/utils:/opt/airflow/utils
      - ./pipelines/config:/opt/airflow/config
      - ./pipelines/ingestion:/opt/airflow/ingestion
      - ./pipelines/loaders:/opt/airflow/loaders
      - ./transformations:/opt/airflow/transformations
      - ./infrastructure/airflow/init-connections.sh:/opt/airflow/scripts/init-connections.sh
      - ./scripts:/opt/airflow/scripts/data
      - ./data-quality:/opt/airflow/data-quality
    depends_on:
      postgres:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    restart: "no"

  airflow-webserver:
    <<: *airflow-common
    command: webserver
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8080}:8080"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  airflow-scheduler:
    <<: *airflow-common
    command: scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  # -- Superset --
  superset:
    image: apache/superset:3.1.3
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-change-me-in-production}
      # Superset metadata database (PostgreSQL instead of default SQLite)
      SUPERSET_DATABASE_URI: ${SUPERSET_DATABASE_URI:-postgresql+psycopg2://${POSTGRES_USER:-airflow}:${POSTGRES_PASSWORD:-airflow}@postgres:5432/${SUPERSET_DB:-superset}}
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USER:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@example.com}
      SUPERSET_ADMIN_FIRSTNAME: Admin
      SUPERSET_ADMIN_LASTNAME: User
      # Database connection for warehouse
      POSTGRES_USER: ${POSTGRES_USER:-airflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
      POSTGRES_DB: ${POSTGRES_DB:-airflow}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    volumes:
      - ./infrastructure/superset:/app/superset_init
      - ./infrastructure/superset/docker-entrypoint.sh:/app/docker-entrypoint.sh
    entrypoint: /bin/bash
    command:
      - /app/docker-entrypoint.sh
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # -- OpenMetadata (Data Catalog & Governance) --
  openmetadata-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -E '(green|yellow)'"]
      interval: 15s
      timeout: 10s
      retries: 10

  openmetadata-server:
    image: openmetadata/server:1.3.1
    environment:
      # Database configuration (uses existing PostgreSQL)
      DB_DRIVER_CLASS: org.postgresql.Driver
      DB_SCHEME: postgresql
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: ${POSTGRES_USER:-airflow}
      DB_USER_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
      OM_DATABASE: openmetadata_db
      # Elasticsearch configuration
      ELASTICSEARCH_HOST: openmetadata-elasticsearch
      ELASTICSEARCH_PORT: "9200"
      ELASTICSEARCH_SCHEME: http
      # Server configuration
      SERVER_HOST: openmetadata-server
      SERVER_PORT: "8585"
      SERVER_ADMIN_PORT: "8586"
      # Authentication (basic auth for development)
      AUTHENTICATION_PROVIDER: basic
      AUTHENTICATION_PUBLIC_KEYS: "[http://localhost:8585/api/v1/system/config/jwks]"
      AUTHENTICATION_AUTHORITY: "http://localhost:8585/api/v1/system/config/authorizer"
      AUTHENTICATION_CLIENT_ID: open-metadata
      AUTHENTICATION_CALLBACK_URL: "http://localhost:8585/callback"
      # Airflow integration
      PIPELINE_SERVICE_CLIENT_ENABLED: "true"
      PIPELINE_SERVICE_CLIENT_HOST: http://airflow-webserver:8080
      PIPELINE_SERVICE_CLIENT_CLASS_NAME: "org.openmetadata.service.clients.pipeline.airflow.AirflowRESTClient"
      PIPELINE_SERVICE_IP_INFO_ENABLED: "false"
      AIRFLOW_USERNAME: ${AIRFLOW_ADMIN_USER:-admin}
      AIRFLOW_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-admin}
      # JWT configuration
      RSA_PUBLIC_KEY_FILE_PATH: ""
      RSA_PRIVATE_KEY_FILE_PATH: ""
      JWT_ISSUER: open-metadata.org
      JWT_KEY_ID: Gb389a-9f76-gdjs-a92j-0242ac120002
      # Authorizer configuration
      AUTHORIZER_CLASS_NAME: org.openmetadata.service.security.DefaultAuthorizer
      AUTHORIZER_REQUEST_FILTER: org.openmetadata.service.security.JwtFilter
      AUTHORIZER_ADMIN_PRINCIPALS: "[admin]"
      AUTHORIZER_PRINCIPAL_DOMAIN: "open-metadata.org"
    ports:
      - "${OPENMETADATA_PORT:-8585}:8585"
      - "${OPENMETADATA_ADMIN_PORT:-8586}:8586"
    volumes:
      - ./infrastructure/openmetadata/ingestion:/opt/openmetadata/ingestion
    depends_on:
      postgres:
        condition: service_healthy
      openmetadata-elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/api/v1/system/version"]
      interval: 30s
      timeout: 10s
      retries: 10

  openmetadata-ingestion:
    image: openmetadata/ingestion:1.3.1
    environment:
      AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth
      # OpenMetadata connection
      OPENMETADATA_SERVER_HOST: openmetadata-server
      OPENMETADATA_SERVER_PORT: "8585"
      # Authentication for ingestion (aligned with server's basic auth)
      # Use 'no-auth' for local development, 'basic' for production
      OPENMETADATA_AUTH_PROVIDER: ${OPENMETADATA_AUTH_PROVIDER:-basic}
      OPENMETADATA_USERNAME: ${OPENMETADATA_USERNAME:-admin}
      OPENMETADATA_PASSWORD: ${OPENMETADATA_PASSWORD:-admin}
      # JWT token for API authentication (generate from OpenMetadata UI or API)
      OPENMETADATA_JWT_TOKEN: ${OPENMETADATA_JWT_TOKEN:-}
      # Database connections for ingestion
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: ${POSTGRES_USER:-airflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-airflow}
      POSTGRES_DB: ${POSTGRES_DB:-airflow}
      # MinIO connection
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minio}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minio123}
      # Ingestion schedule (cron format, default: every 6 hours)
      INGESTION_CRON_SCHEDULE: ${INGESTION_CRON_SCHEDULE:-0 */6 * * *}
    volumes:
      - ./infrastructure/openmetadata/ingestion:/opt/airflow/dags
      - ./transformations:/opt/airflow/transformations
    entrypoint: /bin/bash
    command:
      - -c
      - |
        chmod +x /opt/airflow/dags/run_ingestion.sh
        /opt/airflow/dags/run_ingestion.sh
    depends_on:
      openmetadata-server:
        condition: service_healthy
    restart: unless-stopped

  # RBAC Initialization (one-shot service)
  openmetadata-rbac-init:
    image: python:3.11-slim
    environment:
      OPENMETADATA_SERVER: http://openmetadata-server:8585
      RBAC_CONFIG: /opt/openmetadata/rbac/roles_config.yaml
      # JWT token for admin operations (preferred)
      OPENMETADATA_JWT_TOKEN: ${OPENMETADATA_JWT_TOKEN:-}
      # Basic auth credentials (fallback when JWT token is not provided)
      OPENMETADATA_USERNAME: ${OPENMETADATA_USERNAME:-admin}
      OPENMETADATA_PASSWORD: ${OPENMETADATA_PASSWORD:-admin}
    volumes:
      - ./infrastructure/openmetadata/rbac:/opt/openmetadata/rbac
    entrypoint: /bin/bash
    command:
      - -c
      - |
        pip install -q requests pyyaml
        chmod +x /opt/openmetadata/rbac/run_rbac_init.sh
        /opt/openmetadata/rbac/run_rbac_init.sh
    depends_on:
      openmetadata-server:
        condition: service_healthy
    restart: "no"

volumes:
  postgres-data:
  minio-data:
  elasticsearch-data:
